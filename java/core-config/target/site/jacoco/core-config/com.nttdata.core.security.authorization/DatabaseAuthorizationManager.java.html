<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DatabaseAuthorizationManager.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">core-config</a> &gt; <a href="../index.html" class="el_bundle">core-config</a> &gt; <a href="index.source.html" class="el_package">com.nttdata.core.security.authorization</a> &gt; <span class="el_source">DatabaseAuthorizationManager.java</span></div><h1>DatabaseAuthorizationManager.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (C) 2023 NTT DATA, All Rights Reserved
 *******************************************************************************/
package com.nttdata.core.security.authorization;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.function.Supplier;
import java.util.stream.Collectors;

import javax.servlet.http.HttpServletRequest;

import org.springframework.security.authorization.AuthorizationDecision;
import org.springframework.security.authorization.AuthorizationManager;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;

import com.nttdata.core.authorities.model.Authority;
import com.nttdata.core.common.exception.CoreException;
import com.nttdata.core.mappings.model.Mapping;
import com.nttdata.core.mappings.service.MappingService;

import lombok.extern.slf4j.Slf4j;

/**
 * Allow to get the associated request mapping authorities from database.
 * If none is found in database will use spring security defined mappings.
 * 
 * @author NTT DATA
 * @since 0.0.1
 */
<span class="nc" id="L34">@Slf4j</span>
public class DatabaseAuthorizationManager implements AuthorizationManager&lt;HttpServletRequest&gt; {
	
	/** mappingService for authorities retrieve operations */
	private final MappingService mappingService;
	
	/** Original authorizationManager created by spring */
	private final AuthorizationManager&lt;HttpServletRequest&gt; authorizationManager;
	
	/** When true database defined security attributes 
	 * and spring security config attributes that meets the criteria are returned */
	private final boolean mergeAttributes;

	/**
	 * Creates a new {@link DatabaseAuthorizationManager}
	 * @param mappingService {@link MappingService} to use
	 * @param am {@link AuthorizationManager} created in spring auto configure
	 */
	public DatabaseAuthorizationManager(MappingService mappingService, AuthorizationManager&lt;HttpServletRequest&gt; am) {
<span class="nc" id="L53">		this(mappingService, am, false);</span>
<span class="nc" id="L54">	}</span>
	
	/**
	 * Creates a new {@link DatabaseAuthorizationManager} with merge attributes option
	 * @param mappingService {@link MappingService} to use
	 * @param am {@link AuthorizationManager} created in spring auto configure
	 * @param mergeAttributes {@link Boolean} Allow merge database and spring config security attributes that match the criteria
	 */
<span class="nc" id="L62">	public DatabaseAuthorizationManager(MappingService mappingService, AuthorizationManager&lt;HttpServletRequest&gt; am, boolean mergeAttributes) {</span>
<span class="nc" id="L63">		this.mappingService = mappingService;</span>
<span class="nc" id="L64">		this.authorizationManager = am;</span>
<span class="nc" id="L65">		this.mergeAttributes = mergeAttributes;</span>
<span class="nc" id="L66">	}</span>
	
	private Collection&lt;String&gt; getPermissions(final HttpServletRequest request, boolean patterMatch) throws CoreException {
<span class="nc" id="L69">		List&lt;Mapping&gt; apiMappings = mappingService.getApiMappings(true);</span>
<span class="nc" id="L70">		Collection&lt;String&gt; attributes = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">		for (Mapping mapping : apiMappings) {</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">			if(patterMatch) {</span>
<span class="nc" id="L73">				AntPathRequestMatcher patternMatcher = new AntPathRequestMatcher(mapping.getPattern());</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">				if (patternMatcher.matches(request)) {</span>
<span class="nc" id="L75">					attributes.addAll(</span>
<span class="nc" id="L76">							mapping.getAuthorities().stream().map(Authority::getName).collect(Collectors.toList()));</span>
				}	
<span class="nc" id="L78">			} else {</span>
<span class="nc" id="L79">				attributes.addAll(mapping.getAuthorities().stream().map(Authority::getName).collect(Collectors.toList()));</span>
			}
<span class="nc" id="L81">		}</span>
<span class="nc" id="L82">		return attributes;</span>
	}

	/**
	 * Get the required authorities from the database for the requested {@link HttpServletRequest} path &lt;br&gt;
	 * and evaluate against the current user authorities if is authorized to access the requested resource.
	 * 
	 * @param authentication {@link Supplier} of {@link Authentication} the current authenticated user
	 * @param request {@link HttpServletRequest} the request to authorize
	 * @return {@link AuthorizationDecision} the authorization desision. True when authorized, false otherwise.
	 */
	@Override
	public AuthorizationDecision check(Supplier&lt;Authentication&gt; authentication, HttpServletRequest request) {
		// De la lista filtrada comprobamos si el usuario tiene los authorities requeridos para acceder.
<span class="nc" id="L96">		Collection&lt;String&gt; permissions = new ArrayList&lt;&gt;();</span>
		try {
<span class="nc" id="L98">			permissions = getPermissions(request, true);</span>
<span class="nc" id="L99">		} catch (CoreException e) {</span>
<span class="nc" id="L100">			log.error(&quot;Could not obtain database mapping authorities&quot;, e);</span>
<span class="nc" id="L101">		}</span>
		
		// Check for database authorization
<span class="nc" id="L104">		boolean hasDatabaseAuthorization = checkDatabaseAuthorization(authentication, permissions);</span>
<span class="nc" id="L105">		boolean hasSpringAuthorization = false;</span>
		
		//If no database attributes registerd or merge is true, get it from spring security
<span class="nc bnc" id="L108" title="All 4 branches missed.">		if (this.mergeAttributes || permissions.isEmpty()) {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">			if (permissions.isEmpty()) {</span>
<span class="nc" id="L110">				log.debug(&quot;No configAttributes found in database, using spring security configAttributes instead.&quot;);</span>
			}
<span class="nc" id="L112">			AuthorizationDecision authorizationDecision = this.authorizationManager.check(authentication, request);</span>
<span class="nc bnc" id="L113" title="All 4 branches missed.">			hasSpringAuthorization = null !=authorizationDecision &amp;&amp; authorizationDecision.isGranted();</span>
		}
<span class="nc bnc" id="L115" title="All 4 branches missed.">		if (hasDatabaseAuthorization || hasSpringAuthorization) {</span>
<span class="nc" id="L116">			return new AuthorizationDecision(true);</span>
		}
<span class="nc" id="L118">		return new AuthorizationDecision(false);</span>
	}
	
	/**
	 * Evaluate the current user authorities looking up if is authorized to access the requested resource
	 *
	 * @param authentication {@link Supplier} of {@link Authentication} the authenticated user.
	 * @param permissions {@link Collection} of {@link String} the authorities needed to access the resource
	 * @return {@link Boolean} true when the user is authorized, false otherwise
	 */
	private boolean checkDatabaseAuthorization(Supplier&lt;Authentication&gt; authentication, Collection&lt;String&gt; permissions) {
<span class="nc" id="L129">		Collection&lt;? extends GrantedAuthority&gt; authorities = authentication.get().getAuthorities();</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">		for (String permission : permissions) {</span>
			// Attempt to find a matching granted authority
<span class="nc bnc" id="L132" title="All 2 branches missed.">			for (GrantedAuthority authority : authorities) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">				if (permission.equals(authority.getAuthority())) {</span>
<span class="nc" id="L134">					return true;</span>
				}
<span class="nc" id="L136">			}</span>
<span class="nc" id="L137">		}</span>
<span class="nc" id="L138">		return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>